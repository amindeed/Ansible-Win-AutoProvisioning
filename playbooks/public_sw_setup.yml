---
################################################################################
# SYSTEM INITIALIZATION - REQUIRED
################################################################################
# This play sets up the base system framework and must run before any software
# setups. It creates:
#   - PowerShell helper modules (AWAP.PSModules)
#   - Startup script framework (starter.ps1)
#   - Environment variable management functions
#
# Safe to modify:
#   - Add play-level variables if needed
################################################################################

- name: "Initialize the system"
  hosts: windows
  gather_facts: no
  tags: [initsys, always]
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: initsys
        pre_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: /init-system/AWAP.PSModules
                destination: C:\Program Files\WindowsPowerShell\Modules\
                #force_overwrite_dest: no # By default, Files are only replaced if different, and folders are always forced
                #skip_if_path_exists: C:\Program Files\WindowsPowerShell\Modules\AWAP.PSModules\

              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: /init-system/starter.ps1
                destination: C:\opt\ScriptPS\Starter\
              
              - resource_type: file_system
                operation_type: shortcut
                source: '%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe'
                arguments: '-WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\opt\ScriptPS\Starter\starter.ps1"'
                destination: '%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup\starter.ps1.lnk'
              
              - resource_type: file_system
                operation_type: create
                destination: C:\opt\ScriptPS\Starter\startup_scripts

              # ---- TODO ------
              # Optional: Enterprise CA certificates
              # Uncomment and configure if your organization requires custom CA certs
              #- resource_type: file_system
              #  operation_type: transfer
              #  source:
              #    file_full_url: URL_to_cert_bundle
              #  destination: C:\ProgramData\AWAP\Certificates 
                
################################################################################
# SOFTWARE SETUPS
################################################################################
# Add your application setup plays below.
# Each play should have a unique tag for selective execution.
#
# Examples:
#   --tags "openjdk"            # Setup Java (initsys runs automatically)
#   --tags "openssl,openjdk"     # Setup multiple applications
#   --tags "all"                # Setup everything
#
# Advanced:
#   --skip-tags "initsys"       # Skip system initialization
#                               # Use ONLY if initsys already run successfully
#                               # on the target machine (saves time on re-runs)
#
# Note: 'initsys' is tagged with 'always' and runs automatically unless
#       explicitly skipped. It is idempotent (safe to run multiple times).
################################################################################

- name: "Setup OpenJDK: Eclipse Temurin JDK 8, 11 and 17"
  hosts: windows
  gather_facts: no
  tags: openjdk
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: openjdk
        setup:
          - installations:
            - software_components:
              - software_fullname: Eclipse Temurin JDK with Hotspot 8u382-b05 (x64)
                file_relative_url: eclipse_temurin_openjdk/OpenJDK8U-jdk_x64_windows_hotspot_8u382b05.msi
                type: msi
                additional_arguments: ADDLOCAL=FeatureMain
                root_install_dir: '{{ root_install_dir }}\Java'
                #abort_on_aftercheck_failure: no # Default: yes

              - software_fullname: Eclipse Temurin JDK with Hotspot 11.0.20.1+1 (x64)
                file_relative_url: eclipse_temurin_openjdk/OpenJDK11U-jdk_x64_windows_hotspot_11.0.20.1_1.msi
                type: msi
                additional_arguments: ADDLOCAL=FeatureMain
                root_install_dir: '{{ root_install_dir }}\Java'
                #abort_on_aftercheck_failure: no # Default: yes

              - software_fullname: Eclipse Temurin JDK with Hotspot 17.0.8.1+1 (x64)
                file_relative_url: eclipse_temurin_openjdk/OpenJDK17U-jdk_x64_windows_hotspot_17.0.8.1_1.msi
                type: msi
                additional_arguments: ADDLOCAL=FeatureMain
                root_install_dir: '{{ root_install_dir }}\Java'
                #abort_on_aftercheck_failure: no # Default: yes

        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: core_win/setup-openjdk/set_JAVA_HOME.ps1
                destination: '{{ root_install_dir }}\Java\'

              - resource_type: file_system
                operation_type: shortcut
                source: '%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe'
                arguments: '-WindowStyle Hidden -ExecutionPolicy Bypass -File "{{ root_install_dir }}\Java\set_JAVA_HOME.ps1"'
                destination: '%PUBLIC%\Desktop\Set Runtime Versions\Set JAVA Version.lnk'
                icon: '{{ root_install_dir }}\Java\Eclipse Temurin JDK with Hotspot 11.0.20.1+1 (x64)\bin\java.exe,0'

  #tasks:
  #  - name: '[POST-SETUP] {OPENJDK} Notify logged in users with a message'
  #    community.windows.win_msg:
  #      display_seconds: 259200
  #      msg: "** SYSTEM ADMIN ** \n\nJAVA configurations updated. Please, save your work and log off (sign out) to enable them."
  #    changed_when: false
  #    no_log: yes


- name: "Setup Notepad++"
  hosts: windows
  gather_facts: no
  tags: notepadpp
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: notepadpp
        setup:
          - installations:
            - software_components:
              - software_fullname: Notepad++ # Provide a relevant name that is both human-readable and recognizable by the system (check: tools/check_software_installed.ps1)
                file_relative_url: notepadpp/npp.8.5.4.Installer.x64.exe
                type: exe
                arguments: /S /D={{ root_install_dir }}\Notepad++
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: shortcut
                source: '{{ root_install_dir }}\Notepad++\notepad++.exe'
                destination: '%PUBLIC%\Desktop\Notepad++.lnk'

              # https://github.com/notepad-plus-plus/nppPluginList/blob/master/doc/plugin_list_x64.md  
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/AutoSave_dll_2v00_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\AutoSave\'
                unzip: yes # Default: 'no'
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/DSpellCheck_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\DSpellCheck\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/LanguageHelp_dll_1v75_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\LanguageHelp\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/MenuIcons_dll_2v03_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\MenuIcons\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/OpenSelection_dll_1v13_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\OpenSelection\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/RunMe_dll_1v61_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\RunMe\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/TakeNotes_dll_1v26_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\TakeNotes\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/TopMost_dll_1v42_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\TopMost\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/ComparePlus_cp_1.1.0_x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\ComparePlus\'
                unzip: yes
                force_overwrite_dest: no # Default: yes

              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: notepadpp/plugins/NppFTP-x64.zip
                destination: '{{ root_install_dir }}\Notepad++\plugins\NppFTP\'
                unzip: yes
                force_overwrite_dest: no # Default: yes
              

- name: "Setup 7-Zip"
  hosts: windows
  gather_facts: no
  tags: 7zip
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: 7zip
        setup:
          - installations:
            - software_components:
              - software_fullname: "7-Zip"
                file_relative_url: 7zip/7z2301-x64.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}'
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: template
                source:
                  upload_template: core_win/setup-7zip/set_7zip_settings.reg.j2
                destination: '{{ win_temp_dir_path }}\set_7zip_settings.reg'
          - configurations:
            - update_resource:
              - resource_type: registry
                operation_type: merge
                file_path: '{{ win_temp_dir_path }}\set_7zip_settings.reg'
        template_vars:
          install_dir: D:\\AppServ\\7-Zip


- name: "Setup OpenSSL"
  hosts: windows
  gather_facts: no
  tags: openssl
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: openssl
        pre_setup:
          - installations:
            - software_components:
              - software_fullname: "Microsoft Visual C++ 2022 X64"
                file_relative_url: ms-vc-redist/VC_redist.x64_15-17-19-22.exe
                type: exe
                arguments: "/q /norestart" 
        setup:
          - installations:
            - software_components:
              - software_fullname: "OpenSSL"
                file_relative_url: openssl/Win64OpenSSL_Light-3_1_2.exe
                type: exe
                arguments: /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /DIR={{ root_install_dir }}\OpenSSL-Win64
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: env_var
                resource_name: PATH
                value: '{{ root_install_dir }}\OpenSSL-Win64\bin'
                action: append


- name: "Setup KeePass"
  hosts: windows
  gather_facts: no
  tags: keepass
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: keepass
        setup:
          - installations:
            - software_components:
              - software_fullname: "KeePass"
                file_relative_url: keepass/KeePass-2.54.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}'


- name: "Setup Firefox"
  hosts: windows
  gather_facts: no
  tags: firefox
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: firefox
        setup:
          - installations:
            - software_components:
              - software_fullname: "Firefox"
                file_relative_url: firefox/FirefoxSetup114.0.2.exe
                type: exe
                arguments: -ms /MaintenanceService=false /InstallDirectoryPath={{ root_install_dir }}\Firefox


- name: "Setup Draw.io"
  hosts: windows
  gather_facts: no
  tags: drawio
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: drawio
        setup:
          - installations:
            - software_components:
              - software_fullname: "draw.io"
                file_relative_url: draw-io/draw.io-21.6.8-windows-installer.exe
                type: exe
                arguments: /allusers /S /D={{ root_install_dir }}\Draw.io


- name: "Setup Pandoc"
  hosts: windows
  gather_facts: no
  tags: pandoc
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: pandoc
        setup:
          - installations:
            - software_components:
              - software_fullname: "Pandoc"
                file_relative_url: pandoc/pandoc-3.1.3-windows-x86_64.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}'


- name: "Setup BeyondCompare"
  hosts: windows
  gather_facts: no
  tags: beyondcompare
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: beyondcompare
        setup:
          - installations:
            - software_components:
              - software_fullname: "Beyond Compare"
                file_relative_url: beyond-compare/BCompare-4.4.6.27483_x64.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}'


- name: "Setup Adobe PDF Reader"
  hosts: windows
  gather_facts: no
  tags: adobereader
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: adobereader
        setup:
          - installations:
            - software_components:
              - software_fullname: "Adobe Acrobat Reader"
                file_relative_url: adobe-reader/AcroRdrDC2300320201_en_US.exe
                type: exe
                arguments: /sAll /rs /msi /norestart EULA_ACCEPT=YES INSTALLDIR={{ root_install_dir }}\Adobe DISABLEDESKTOPSHORTCUT=1


- name: "Setup Greenshot"
  hosts: windows
  gather_facts: no
  tags: greenshot
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: greenshot
        setup:
          - installations:
            - software_components:
              - software_fullname: "Greenshot"
                file_relative_url: greenshot/Greenshot-INSTALLER-1.2.10.6-RELEASE.exe
                type: exe
                arguments: /DIR={{ root_install_dir }}\Greenshot /VERYSILENT /NORESTART


- name: "Setup Keystore Explorer"
  hosts: windows
  gather_facts: no
  tags: keystoreexplorer
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: keystoreexplorer
        setup:
          - installations:
            - software_components:
              - software_fullname: "Keystore Explorer"
                file_relative_url: keystore-explorer/kse-552-setup.exe
                type: exe
                arguments: /DIR={{ root_install_dir }}\KeystoreExplorer /VERYSILENT /NORESTART /ALLUSERS


- name: "Setup MarkText"
  hosts: windows
  gather_facts: no
  tags: marktext
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: marktext
        setup:
          - installations:
            - software_components:
              - software_fullname: "MarkText"
                file_relative_url: marktext/marktext-setup_v0_17_1.exe
                type: exe
                arguments: /allusers /S /D={{ root_install_dir }}\MarkText
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: remove
                destination: '%PUBLIC%\Desktop\Marktext.lnk'


- name: "Setup VSCode"
  hosts: windows
  gather_facts: no
  tags: vscode
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: vscode
        setup:
          - installations:
            - software_components:
              - software_fullname: "Microsoft Visual Studio Code"
                file_relative_url: vscode/VSCodeSetup-x64-1.80.2.exe
                type: exe
                arguments: /DIR={{ root_install_dir }}\VSCode /VERYSILENT /NORESTART /MERGETASKS=!runcode,desktopicon,addcontextmenufiles,addcontextmenufolders
                #clean_downloads: false


- name: "Setup Sysinternals Suite"
  hosts: windows
  gather_facts: no
  tags: sysinternals
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: sysinternals
        setup:
          - installations:
            - software_components:
              - software_fullname: "Sysinternals Suite" 
                file_relative_url: sysinternals/SysinternalsSuite.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                #desktop_shortcut: yes # Default: no
                #startmenu_shortcut: no # Default: yes


- name: "Setup RegShot"
  hosts: windows
  gather_facts: no
  tags: regshot
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: regshot
        setup:
          - installations:
            - software_components:
              - software_fullname: "RegShot" 
                file_relative_url: regshot/Regshot-1.9.1-beta_r321.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: Regshot-x64-Unicode.exe


- name: "Setup Dependency Walker"
  hosts: windows
  gather_facts: no
  tags: dependencywalker
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: dependencywalker
        setup:
          - installations:
            - software_components:
              - software_fullname: "Dependency Walker" 
                file_relative_url: dependency-walker/depends22_x64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: 'depends.exe'
                desktop_shortcut: no # Default: no
                startmenu_shortcut: yes # Default: yes


- name: "Setup TreeSize"
  hosts: windows
  gather_facts: no
  tags: treesize
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: treesize
        setup:
          - installations:
            - software_components:
              - software_fullname: "TreeSize"
                file_relative_url: treesize/TreeSize_v4.7.2.exe
                type: exe
                arguments: /DIR={{ root_install_dir }}\TreeSize /VERYSILENT /NORESTART /ALLUSERS


- name: Setup Node.JS v14, v16 and v18
  hosts: windows
  gather_facts: no
  tags: nodejs
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: nodejs
        setup:
          - installations:
            - software_components:
              - software_fullname: "NodeJS v14.17.3" 
                file_relative_url: nodejs/node-v14.17.3-win-x64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}\nodejs'
                desktop_shortcut: no # Default: no
                startmenu_shortcut: no # Default: yes

              - software_fullname: "NodeJS v16.16.0" 
                file_relative_url: nodejs/node-v16.16.0-win-x64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}\nodejs'
                desktop_shortcut: no # Default: no
                startmenu_shortcut: no # Default: yes

              - software_fullname: "NodeJS v18.18.0" 
                file_relative_url: nodejs/node-v18.18.0-win-x64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}\nodejs'
                desktop_shortcut: no # Default: no
                startmenu_shortcut: no # Default: yes

        post_setup:
          - configurations:
            - update_resource:
              ## [Optional] Set default NodeJS version in the environment at user session logon
              #- resource_type: file_system
              #  operation_type: transfer
              #  source:
              #    upload_file: basic_win/setup-nodejs/check_NODEJS_HOME.ps1
              #  destination: C:\opt\ScriptPS\Starter\startup_scripts\

              ## Set default NODEJS_HOME (v18.18.0)
              #- resource_type: env_var
              #  resource_name: NODEJS_HOME
              #  value: {{ root_install_dir }}\nodejs\NodeJS v18.18.0\node-v18.18.0-win-x64
              #  action: set
              #
              ## Add NodeJS to PATH (v18.18.0)
              #- resource_type: env_var
              #  resource_name: PATH
              #  value: '"%NODEJS_HOME%"'
              #  action: append
              
              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: basic_win/setup-nodejs/set_NODEJS_HOME.ps1
                destination: '{{ root_install_dir }}\NodeJS\'

              - resource_type: file_system
                operation_type: shortcut
                source: '%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe'
                arguments: '-WindowStyle Hidden -ExecutionPolicy Bypass -File "{{ root_install_dir }}\nodejs\set_NODEJS_HOME.ps1"'
                destination: '%PUBLIC%\Desktop\Set Runtime Versions\Set NodeJs Version.lnk'
                icon: '{{ root_install_dir }}\nodejs\NodeJS v18.18.0\node-v18.18.0-win-x64\node.exe,0'

  #tasks:
  #  - name: '[POST-SETUP] {NODEJS} Notify logged in users with a message'
  #    community.windows.win_msg:
  #      display_seconds: 259200
  #      msg: "** SYSTEM ADMIN ** \n\nNode.JS configurations updated. Please, save your work and log off (sign out) to enable them."
  #    changed_when: false
  #    no_log: yes


- name: "Setup Eclipse IDE for JEE: 2022-12, 2020-06, Oxygen (2017-06) and Neon 3 (2016-06)"
  hosts: windows
  gather_facts: no
  tags: eclipseide
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: eclipseide
        setup:
          - installations:
            - software_components:
              - software_fullname: "Eclipse IDE 2020-06" 
                file_relative_url: eclipse_jee_ide/eclipse-jee-2020-06-R-win32-x86_64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: eclipse\eclipse.exe
                desktop_shortcut: yes # Default: no
                shortcut_name: 'Eclipse IDEs\Eclipse 2020-06' # Default shortcut name == 'software_fullname'
                startmenu_shortcut: yes # Default: yes
                #
              - software_fullname: "Eclipse IDE 2022-12" 
                file_relative_url: eclipse_jee_ide/eclipse-jee-2022-12-R-win32-x86_64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: eclipse\eclipse.exe
                desktop_shortcut: yes # Default: no
                shortcut_name: 'Eclipse IDEs\Eclipse IDE 2022-12'
                startmenu_shortcut: yes # Default: yes
                #
              - software_fullname: "Eclipse IDE Neon 3 (2016-06)" 
                file_relative_url: eclipse_jee_ide/eclipse-jee-neon-3-win32-x86_64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: eclipse\eclipse.exe
                desktop_shortcut: yes # Default: no
                shortcut_name: 'Eclipse IDEs\Eclipse IDE Neon 3 (2016-06)'
                startmenu_shortcut: yes # Default: yes
                #
              - software_fullname: "Eclipse IDE Oxygen (2017-06)" 
                file_relative_url: eclipse_jee_ide/eclipse-jee-oxygen-R-win32-x86_64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                main_app_launcher: eclipse\eclipse.exe
                desktop_shortcut: yes # Default: no
                shortcut_name: 'Eclipse IDEs\Eclipse IDE Oxygen (2017-06)'
                startmenu_shortcut: yes # Default: yes
              

- name: Setup Cygwin x64
  hosts: windows
  gather_facts: no
  tags: cygwin
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: cygwin
        setup:
          - installations:
            - software_components:
              - software_fullname: Cygwin
                file_relative_url: cygwin/cygwin_v3_4_9_setup-x86_64.exe
                type: exe
                # /!\ Intall packages from the public internet
                arguments: --quiet-mode --wait --site https://mirrors.kernel.org/sourceware/cygwin/ --site https://mirrors.filigrane-technologie.fr/cygwin/ --root {{ root_install_dir }}\Cygwin\cygwin64 --no-shortcuts --packages gcc-core,make,binutils,gdb,cygwin-devel,pkg-config,libncurses-devel,gettext-devel
                manual_registration:
                  root_install_dir: '{{ root_install_dir }}'
                  main_app_launcher: cygwin64\bin\mintty.exe
                  desktop_shortcut: yes
                  startmenu_shortcut: yes
                  shortcut_arguments: '-i /Cygwin-Terminal.ico -'
                  shortcut_icon: '{{ root_install_dir }}\Cygwin\cygwin64\Cygwin.ico'  # Provide full path, optionnally followed with icon index, e.g. 'filpath,12'
                #abort_on_aftercheck_failure: no # Default: yes


- name: "Setup DBeaver"
  hosts: windows
  gather_facts: no
  tags: dbeaver
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: dbeaver
        setup:
          - installations:
            - software_components:
              - software_fullname: "DBeaver"
                file_relative_url: dbeaver/dbeaver-ce-23.2.1-x86_64-setup.exe
                type: exe
                arguments: /allusers /S /D={{ root_install_dir }}\DBeaver
                #clean_downloads: false


- name: "Setup Git Extensions"
  hosts: windows
  gather_facts: no
  tags: gitextensions
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: gitextensions
        pre_setup:
          - installations:
            - software_components:
              - software_fullname: Microsoft Windows Desktop Runtime
                file_relative_url: ms-dotnet/windowsdesktop-runtime-6.0.24-win-x64.exe
                type: exe
                arguments: /install /quiet /norestart
              - software_fullname: Git
                file_relative_url: git/Git-2.42.0.2-64-bit.exe
                type: exe
                arguments: /DIR={{ root_install_dir }}\Git /VERYSILENT /NORESTART /COMPONENTS=icons,icons\desktop,ext,ext\shellhere,ext\guihere,gitlfs,assoc,assoc_sh
                #clean_downloads: false
              - software_fullname: "kdiff3"
                file_relative_url: kdiff3/kdiff3-1.10.5-windows-x86_64.exe
                type: exe
                arguments: /S /D={{ root_install_dir }}\KDiff3
        setup:
          - installations:
            - software_components:
              - software_fullname: Git Extensions
                file_relative_url: gitextensions/GitExtensions-4.1.0.16698-1fe52a137.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}'
                #clean_downloads: true


- name: "Setup UML Designer"
  hosts: windows
  gather_facts: no
  tags: umldesigner
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: umldesigner
        setup:
          - installations:
            - software_components:
              - software_fullname: "UMLDesigner" # /!\ Attention when 'create_directory' is set to 'no' /!\
                file_relative_url: umldesigner/UMLDesigner_v9-win32.win32.x86_64.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                create_directory: no # Default: yes
                main_app_launcher: UMLDesigner.exe
                desktop_shortcut: yes # Default: no
                #startmenu_shortcut: yes # Default: yes


- name: "Setup Apache Maven"
  hosts: windows
  gather_facts: no
  tags: maven
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: maven
        setup:
          - installations:
            - software_components:
              - software_fullname: "apache-maven-3.9.4" # /!\ Attention when 'create_directory' is set to 'no' /!\
                file_relative_url: maven/apache-maven-3.9.4-bin.zip
                type: zip
                root_install_dir: '{{ root_install_dir }}'
                create_directory: no # Default: yes
                desktop_shortcut: no # Default: no
                startmenu_shortcut: no # Default: yes
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: env_var
                resource_name: PATH
                value: '{{ root_install_dir }}\apache-maven-3.9.4\bin'
                action: append


- name: "Setup Python 2"
  hosts: windows
  gather_facts: no
  tags: [python, python2]
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: python2
        pre_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python2/python-2.7.18.amd64-pdb.zip
                destination: '{{ root_install_dir }}\Python\Python2\Symbols'
                unzip: yes
                skip_if_path_exists: '{{ root_install_dir }}\Python\Python2\Symbols'
        setup:
          - installations:
            - software_components:
              - software_fullname: Python 2.7.18 (64-bit)
                file_relative_url: python2/python-2.7.18.amd64.msi
                type: msi
                root_install_dir: '{{ root_install_dir }}\Python'
                install_directory_name: Python2
                #additional_arguments: ALLUSERS=1 ADDLOCAL=ALL
                additional_arguments: ALLUSERS=1 ADDLOCAL=DefaultFeature,TclTk,Documentation,Tools,pip_feature,Testsuite
                #abort_on_aftercheck_failure: no # Default: yes
        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: basic_win/setup-python/set_PYTHON_paths.ps1
                destination: '{{ root_install_dir }}\Python\'

              - resource_type: file_system
                operation_type: shortcut
                source: '%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe'
                arguments: '-WindowStyle Hidden -ExecutionPolicy Bypass -File "{{ root_install_dir }}\Python\set_PYTHON_paths.ps1"'
                destination: '%PUBLIC%\Desktop\Set Runtime Versions\Set Python Version.lnk'
                icon: '{{ root_install_dir }}\Python\Python2\python.exe,0'


- name: "Setup Python 3.12"
  hosts: windows
  gather_facts: no
  tags: [python, python312]
  roles:
    - role: ans-win-auto-prov
      vars:
        shortname: python312
        pre_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/core_pdb.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/core_d.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/exe_pdb.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/exe_d.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/dev_d.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/lib_pdb.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/lib_d.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/test_pdb.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/test_d.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/tcltk_pdb.msi
                destination: "{{ win_temp_dir_path }}"
              - resource_type: file_system
                operation_type: transfer
                source:
                  file_relative_url: python312/tcltk_d.msi
                destination: "{{ win_temp_dir_path }}"
        setup:
          - installations:
            - software_components:
              - software_fullname: "Python 3.12.0"
                file_relative_url: python312/python-3.12.0-amd64.exe
                type: exe
                arguments: /quiet InstallAllUsers=1 TargetDir={{ root_install_dir }}\Python\Python312 PrependPath=0 AppendPath=0 AssociateFiles=0 Include_symbols=1 Include_debug=1
                root_install_dir: '{{ root_install_dir }}\Python\Python312'

        post_setup:
          - configurations:
            - update_resource:
              - resource_type: file_system
                operation_type: transfer
                source:
                  upload_file: basic_win/setup-python/set_PYTHON_paths.ps1
                destination: '{{ root_install_dir }}\Python\'

              - resource_type: file_system
                operation_type: shortcut
                source: '%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe'
                arguments: '-WindowStyle Hidden -ExecutionPolicy Bypass -File "{{ root_install_dir }}\Python\set_PYTHON_paths.ps1"'
                destination: '%PUBLIC%\Desktop\Set Runtime Versions\Set Python Version.lnk'
                icon: '{{ root_install_dir }}\Python\Python2\python.exe,0'

  #tasks:
  #  - name: '[POST-SETUP] {PYTHON312} Notify logged in users with a message'
  #    community.windows.win_msg:
  #      display_seconds: 259200
  #      msg: "** SYSTEM ADMIN ** \n\nPython configurations updated. Please, save your work and log off (sign out) to enable them."
  #    changed_when: false
  #    no_log: yes
